// Abbey OS - Family Estate Autopilot Schema
// Mixed-use portfolio: Hotel, Cafe, Residential Flats

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum PropertyType {
  HOTEL
  CAFE
  RESIDENTIAL
}

enum UnitStatus {
  OCCUPIED
  VACANT
  MAINTENANCE
}

enum BookingChannel {
  BOOKING_COM
  EXPEDIA
  AIRBNB
  DIRECT
  PHONE
}

enum BookingStatus {
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PAID
  PARTIAL
  OVERDUE
  PENDING
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ExpenseStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

enum ExpenseCategory {
  UTILITIES
  MAINTENANCE
  SUPPLIES
  PAYROLL
  INSURANCE
  TAXES
  MARKETING
  PROFESSIONAL_FEES
  OTHER
}

enum AlertSeverity {
  CRITICAL
  WARNING
  INFO
}

enum AlertCategory {
  MAINTENANCE
  FINANCIAL
  COMPLIANCE
  OCCUPANCY
  OPERATIONAL
}

enum UserRole {
  OWNER
  GM
  STAFF
}

enum TransactionCategory {
  RENT_INCOME
  HOTEL_REVENUE
  CAFE_REVENUE
  MORTGAGE_PAYMENT
  UTILITIES
  MAINTENANCE
  PAYROLL
  SUPPLIES
  INSURANCE
  TAXES
  OTHER_INCOME
  OTHER_EXPENSE
}

enum DocumentType {
  GAS_CERTIFICATE
  ELECTRICAL_CERTIFICATE
  EPC
  INSURANCE
  LEASE_AGREEMENT
  LICENSE
  OTHER
}

// ============================================
// USER PROFILE (Connected to Clerk)
// ============================================

model UserProfile {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  role      UserRole @default(STAFF)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  auditLogs AuditLog[]
  
  @@map("user_profiles")
}

// ============================================
// CORE ENTITIES
// ============================================

model Property {
  id          String       @id @default(cuid())
  name        String
  type        PropertyType
  address     String
  city        String
  postcode    String
  description String?
  imageUrl    String?
  
  // Financial
  purchasePrice    Float?
  currentValue     Float?
  mortgageBalance  Float?
  interestRate     Float?
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relations
  units            Unit[]
  dailyLogs        DailyLog[]
  expenses         Expense[]
  debts            Debt[]
  alerts           Alert[]
  hotelMetrics     HotelMetric[]
  cafeSales        CafeSales[]
  documents        Document[]
  transactions     FinancialTransaction[]
  
  @@map("properties")
}

model Unit {
  id           String     @id @default(cuid())
  propertyId   String
  property     Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  unitNumber   String     // Room number, flat number, etc.
  floor        Int?
  type         String?    // Suite, Standard, Studio, 1-Bed, etc.
  status       UnitStatus @default(VACANT)
  currentRate  Float      // Nightly rate for hotel, monthly rent for residential
  
  // Size & Features
  squareMeters Float?
  bedrooms     Int?
  bathrooms    Int?
  features     String[]   // ["Sea View", "Balcony", "Ensuite"]
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Relations
  bookings     Booking[]
  leases       Lease[]
  rentRolls    RentRoll[]
  
  @@unique([propertyId, unitNumber])
  @@map("units")
}

// ============================================
// THE "TRUTH" LAYER - Data Ingestion Models
// ============================================

// Bank Statement Transactions
model FinancialTransaction {
  id            String              @id @default(cuid())
  propertyId    String?
  property      Property?           @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  date          DateTime            @db.Date
  amount        Float               // Positive = income, Negative = expense
  category      TransactionCategory
  description   String
  
  // Bank account info
  bankAccountId String?
  bankAccountName String?
  reference     String?
  
  // Deduplication
  externalId    String?             @unique // External reference for avoiding duplicates
  
  // Reconciliation
  isReconciled  Boolean             @default(false)
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  @@index([date])
  @@index([category])
  @@map("financial_transactions")
}

// Hotel PMS Import Data
model HotelMetric {
  id           String   @id @default(cuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  date         DateTime @db.Date
  
  // Occupancy metrics
  roomsAvailable  Int
  roomsOccupied   Int
  occupancy       Float    // Percentage 0-100
  
  // Revenue metrics
  adr             Float    // Average Daily Rate
  revpar          Float    // Revenue Per Available Room
  totalRevenue    Float
  roomRevenue     Float
  otherRevenue    Float    @default(0)
  
  // Booking stats
  arrivals        Int      @default(0)
  departures      Int      @default(0)
  stayovers       Int      @default(0)
  
  // Source tracking
  source          String?  // "PMS", "MANUAL", "API"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([propertyId, date])
  @@index([date])
  @@map("hotel_metrics")
}

// Cafe Daily Sales Data
model CafeSales {
  id           String   @id @default(cuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  date         DateTime @db.Date
  
  // Revenue
  grossSales   Float
  netSales     Float?
  vat          Float?
  
  // Covers & Performance
  covers       Int
  avgSpend     Float?
  
  // Costs
  labourCost   Float    @default(0)
  foodCost     Float    @default(0)
  wastage      Float    @default(0)
  
  // Calculated metrics
  grossMargin  Float?   // Percentage
  labourPercentage Float?
  
  // Source tracking
  source       String?  // "POS", "MANUAL", "EPOS"
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([propertyId, date])
  @@index([date])
  @@map("cafe_sales")
}

// Rent Roll - Current State of Residential Units
model RentRoll {
  id              String        @id @default(cuid())
  unitId          String
  unit            Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  // Tenant info
  tenantName      String
  tenantEmail     String?
  tenantPhone     String?
  
  // Lease terms
  leaseStart      DateTime
  leaseEnd        DateTime
  monthlyRent     Float
  
  // Payment status
  paymentStatus   PaymentStatus @default(PENDING)
  arrearsAmount   Float         @default(0)
  arrearsDays     Int           @default(0)
  lastPaymentDate DateTime?
  nextDueDate     DateTime
  
  // Compliance
  depositHeld     Float         @default(0)
  depositScheme   String?       // "DPS", "TDS", "MyDeposits"
  
  isActive        Boolean       @default(true)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([paymentStatus])
  @@index([arrearsDays])
  @@map("rent_rolls")
}

// ============================================
// THE "BRAIN" LAYER - Operations
// ============================================

// Audit Log - Track all user actions
model AuditLog {
  id          String      @id @default(cuid())
  userId      String
  user        UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String      // "CREATE", "UPDATE", "DELETE", "VIEW"
  entityType  String      // "BOOKING", "LEASE", "EXPENSE", etc.
  entityId    String
  
  // Change details
  oldValue    Json?
  newValue    Json?
  
  // Context
  ipAddress   String?
  userAgent   String?
  
  timestamp   DateTime    @default(now())
  
  @@index([entityType, entityId])
  @@index([userId])
  @@map("audit_logs")
}

// Documents - Compliance & Legal
model Document {
  id           String       @id @default(cuid())
  propertyId   String?
  property     Property?    @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  type         DocumentType
  name         String
  url          String       // S3 or storage URL
  
  expiryDate   DateTime?
  
  // Alerts
  alertBefore  Int          @default(30) // Days before expiry to alert
  
  // Metadata
  uploadedBy   String?
  notes        String?
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  @@index([expiryDate])
  @@map("documents")
}

// ============================================
// BUSINESS MODULES
// ============================================

// Hotel Bookings
model Booking {
  id           String        @id @default(cuid())
  unitId       String
  unit         Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  guestName    String
  guestEmail   String?
  guestPhone   String?
  adults       Int           @default(1)
  children     Int           @default(0)
  
  checkIn      DateTime
  checkOut     DateTime
  nights       Int
  
  channel      BookingChannel
  status       BookingStatus @default(CONFIRMED)
  
  // Financials
  roomRate     Float         // Per night
  totalPrice   Float
  deposit      Float         @default(0)
  balance      Float         @default(0)
  
  // Additional
  specialRequests String?
  internalNotes   String?
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  @@map("bookings")
}

// Residential Leases
model Lease {
  id              String        @id @default(cuid())
  unitId          String
  unit            Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  tenantName      String
  tenantEmail     String?
  tenantPhone     String?
  
  startDate       DateTime
  endDate         DateTime
  
  // Financials
  rentAmount      Float         // Monthly rent
  deposit         Float
  paymentStatus   PaymentStatus @default(PENDING)
  arrearsAmount   Float         @default(0)
  lastPaymentDate DateTime?
  
  // Compliance
  rightToRentCheck Boolean      @default(false)
  gasCertExpiry    DateTime?
  epcRating        String?
  
  // Additional
  notes           String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  payments        LeasePayment[]
  
  @@map("leases")
}

model LeasePayment {
  id          String   @id @default(cuid())
  leaseId     String
  lease       Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  
  amount      Float
  dueDate     DateTime
  paidDate    DateTime?
  status      PaymentStatus @default(PENDING)
  method      String?       // "Bank Transfer", "Cash", "Card"
  reference   String?
  
  createdAt   DateTime @default(now())
  
  @@map("lease_payments")
}

// Daily Operational Logs (Cafe & Hotel)
model DailyLog {
  id           String   @id @default(cuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  date         DateTime @db.Date
  
  // Revenue
  salesTotal   Float    @default(0)
  roomRevenue  Float    @default(0)
  fbRevenue    Float    @default(0)
  otherRevenue Float    @default(0)
  
  // Costs
  laborCost    Float    @default(0)
  foodCost     Float    @default(0)
  utilityCost  Float    @default(0)
  otherCost    Float    @default(0)
  
  // Metrics
  covers       Int      @default(0)    // Number of guests served (cafe)
  occupancy    Float?                  // Percentage (hotel)
  adr          Float?                  // Average Daily Rate (hotel)
  revpar       Float?                  // Revenue Per Available Room
  
  // Notes
  notes        String?
  weatherNote  String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([propertyId, date])
  @@map("daily_logs")
}

// Action Items - The Command Center Tasks
model ActionItem {
  id                String       @id @default(cuid())
  
  title             String
  description       String?
  
  priority          Priority     @default(MEDIUM)
  status            ActionStatus @default(PENDING)
  
  // Impact & Urgency
  estimatedImpactGbp Float?      // Potential Â£ impact
  urgencyScore       Int?        // 1-10 scale
  
  // Assignment
  assignedTo        String?
  
  // Dates
  dueDate           DateTime?
  completedAt       DateTime?
  
  // Categorization
  category          String?      // "Maintenance", "Finance", "Legal", etc.
  relatedPropertyId String?
  
  // Auto-generation source
  source            String?      // "SYSTEM", "USER", "AI"
  sourceEntityType  String?      // "RENT_ROLL", "CAFE_SALES", etc.
  sourceEntityId    String?
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@index([priority, status])
  @@index([dueDate])
  @@map("action_items")
}

// ============================================
// FINANCE LAYER
// ============================================

model Expense {
  id           String         @id @default(cuid())
  propertyId   String?
  property     Property?      @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  amount       Float
  category     ExpenseCategory
  vendor       String
  description  String?
  invoiceRef   String?
  
  status       ExpenseStatus  @default(PENDING)
  
  dueDate      DateTime?
  paidDate     DateTime?
  
  isRecurring  Boolean        @default(false)
  recurringDay Int?           // Day of month for recurring
  
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  @@map("expenses")
}

model Debt {
  id            String   @id @default(cuid())
  propertyId    String?
  property      Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  lender        String
  loanType      String   // "Commercial Mortgage", "BTL Mortgage", "Development Loan"
  
  principal     Float
  currentBalance Float
  interestRate  Float    // Annual percentage
  
  monthlyPayment Float
  
  startDate     DateTime
  maturityDate  DateTime
  
  isFixed       Boolean  @default(true)
  fixedUntil    DateTime?
  
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("debts")
}

// ============================================
// ALERTS & NOTIFICATIONS
// ============================================

model Alert {
  id           String        @id @default(cuid())
  propertyId   String?
  property     Property?     @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  title        String
  message      String
  
  severity     AlertSeverity
  category     AlertCategory
  
  isRead       Boolean       @default(false)
  isDismissed  Boolean       @default(false)
  
  // Auto-generated or manual
  source       String?       // "SYSTEM", "USER", "API"
  
  // Link to related item
  relatedType  String?       // "LEASE", "BOOKING", "EXPENSE", etc.
  relatedId    String?
  
  createdAt    DateTime      @default(now())
  
  @@map("alerts")
}

// ============================================
// FORECASTING & ANALYTICS
// ============================================

model Forecast {
  id           String   @id @default(cuid())
  
  date         DateTime @db.Date
  propertyId   String?
  
  // Predicted values
  predictedRevenue   Float?
  predictedOccupancy Float?
  predictedCovers    Float?
  
  // Confidence
  confidenceLevel    Float?   // 0-1
  
  // Model info
  modelVersion       String?
  
  createdAt    DateTime @default(now())
  
  @@unique([date, propertyId])
  @@map("forecasts")
}

// ============================================
// CASH POSITION
// ============================================

model CashPosition {
  id           String   @id @default(cuid())
  
  date         DateTime @db.Date @unique
  
  // Bank balances
  operatingBalance   Float @default(0)
  reserveBalance     Float @default(0)
  
  // Today's movements
  inflows      Float    @default(0)
  outflows     Float    @default(0)
  
  // Projected
  projected30Day     Float?
  projected90Day     Float?
  
  notes        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("cash_positions")
}
