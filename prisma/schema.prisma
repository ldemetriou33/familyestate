// Abbey OS - Family Estate Autopilot Schema
// Mixed-use portfolio: Hotel, Cafe, Residential Flats
// Version 3.0 - Enterprise Control System

generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS - Core
// ============================================

enum PropertyType {
  HOTEL
  CAFE
  RESIDENTIAL
}

enum UnitStatus {
  OCCUPIED
  VACANT
  MAINTENANCE
}

enum BookingChannel {
  BOOKING_COM
  EXPEDIA
  AIRBNB
  DIRECT
  PHONE
}

enum BookingStatus {
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PAID
  PARTIAL
  OVERDUE
  PENDING
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum ExpenseStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

enum ExpenseCategory {
  UTILITIES
  MAINTENANCE
  SUPPLIES
  PAYROLL
  INSURANCE
  TAXES
  MARKETING
  PROFESSIONAL_FEES
  OTHER
}

enum AlertSeverity {
  CRITICAL
  WARNING
  INFO
}

enum AlertCategory {
  MAINTENANCE
  FINANCIAL
  COMPLIANCE
  OCCUPANCY
  OPERATIONAL
  RECONCILIATION
  INTEGRATION
}

enum UserRole {
  OWNER
  GM
  STAFF
  ACCOUNTANT
  READONLY
}

enum TransactionCategory {
  RENT_INCOME
  HOTEL_REVENUE
  CAFE_REVENUE
  MORTGAGE_PAYMENT
  UTILITIES
  MAINTENANCE
  PAYROLL
  SUPPLIES
  INSURANCE
  TAXES
  OTHER_INCOME
  OTHER_EXPENSE
}

enum DocumentType {
  GAS_CERTIFICATE
  ELECTRICAL_CERTIFICATE
  EPC
  INSURANCE
  LEASE_AGREEMENT
  LICENSE
  BOARD_PACK
  PERIOD_CLOSE
  OTHER
  // Legal Brain Document Types
  MORTGAGE
  PLANNING_PERMISSION
  RESTRICTIVE_COVENANT
  CONTRACT
  COMMERCIAL_LEASE
  TITLE_DEED
  SURVEY
  VALUATION
}

// ============================================
// ENUMS - Trust & Controls Layer (NEW)
// ============================================

enum DataSource {
  MANUAL
  XERO
  STRIPE
  PMS_OPERA
  PMS_CLOUDBEDS
  POS_SQUARE
  POS_LIGHTSPEED
  BANK_FEED
  API_IMPORT
  CSV_UPLOAD
  SYSTEM_GENERATED
}

enum ReconciliationStatus {
  PENDING
  MATCHED
  UNMATCHED
  FLAGGED
  FORCE_MATCHED
  EXCLUDED
}

enum DataConfidence {
  VERIFIED    // Cross-checked and confirmed
  HIGH        // Single trusted source
  MEDIUM      // Manual entry, unverified
  LOW         // Estimated or stale
  UNKNOWN
}

enum PeriodStatus {
  OPEN
  SOFT_CLOSE  // No new entries, can reopen
  HARD_CLOSE  // Locked for audit
  ARCHIVED
}

// ============================================
// ENUMS - Action Workflow Layer (NEW)
// ============================================

enum ActionWorkflowStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SCHEDULED
  IN_PROGRESS
  EXECUTED
  VERIFICATION_REQ
  VERIFIED
  FAILED
  CANCELLED
}

enum ActionType {
  ARREARS_CHASE
  RATE_CHANGE
  MAINTENANCE_REQUEST
  COMPLIANCE_RENEWAL
  MARKETING_CAMPAIGN
  VENDOR_PAYMENT
  TENANT_COMMUNICATION
  REPORT_GENERATION
  SYSTEM_TASK
}

// ============================================
// ENUMS - Pricing & Revenue Layer (NEW)
// ============================================

enum RateProposalStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  APPLIED
  EXPIRED
}

enum SeasonType {
  PEAK
  SHOULDER
  OFF_PEAK
  SPECIAL_EVENT
}

// ============================================
// ENUMS - Governance Layer (NEW)
// ============================================

enum ApprovalType {
  EXPENSE
  RATE_CHANGE
  REFUND
  WRITE_OFF
  CONTRACT
  HIRE
  SYSTEM_CONFIG
}

enum DecisionType {
  RATE_CHANGE
  NEW_LOAN
  REFINANCE
  PROPERTY_SALE
  PROPERTY_PURCHASE
  MAJOR_CAPEX
  POLICY_CHANGE
  SYSTEM_CHANGE
}

// ============================================
// ENUMS - Integration Layer (NEW)
// ============================================

enum IntegrationProvider {
  XERO
  QUICKBOOKS
  STRIPE
  GOCARDLESS
  OPERA_PMS
  CLOUDBEDS
  MEWS
  GUESTY
  SQUARE_POS
  LIGHTSPEED
  BANK_OF_ENGLAND
  COMPANIES_HOUSE
}

enum IntegrationStatus {
  ACTIVE
  PAUSED
  ERROR
  DISCONNECTED
  PENDING_AUTH
}

enum SyncFrequency {
  REALTIME
  HOURLY
  DAILY
  WEEKLY
  MANUAL
}

// ============================================
// ORGANIZATION & MULTI-TENANCY (NEW)
// ============================================

model Organization {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  
  // Settings
  timezone        String   @default("Europe/London")
  currency        String   @default("GBP")
  fiscalYearStart Int      @default(4)  // April
  
  // Subscription/Billing (for SaaS)
  plan            String   @default("starter")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  members         OrganizationMember[]
  properties      Property[]
  integrations    IntegrationConnection[]
  approvalThresholds ApprovalThreshold[]
  periods         AccountingPeriod[]
  
  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           UserProfile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role           UserRole     @default(STAFF)
  
  // Permissions can be more granular
  permissions    Permission[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@unique([organizationId, userId])
  @@map("organization_members")
}

model Permission {
  id             String             @id @default(cuid())
  memberId       String
  member         OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  resource       String             // "property", "expense", "rate", "report"
  action         String             // "create", "read", "update", "delete", "approve"
  propertyId     String?            // Optional: scope to specific property
  
  @@unique([memberId, resource, action, propertyId])
  @@map("permissions")
}

// ============================================
// GOVERNANCE - APPROVAL THRESHOLDS (NEW)
// ============================================

model ApprovalThreshold {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  approvalType    ApprovalType
  role            UserRole
  
  maxAmountGbp    Float?       // null = unlimited
  requiresSecondApprover Boolean @default(false)
  
  createdAt       DateTime     @default(now())
  
  @@unique([organizationId, approvalType, role])
  @@map("approval_thresholds")
}

model DecisionLog {
  id              String       @id @default(cuid())
  organizationId  String
  
  decisionType    DecisionType
  title           String
  description     String
  
  // Financial impact
  impactAmountGbp Float?
  
  // Decision details
  decisionMadeBy  String       // User ID
  approvedBy      String?      // Second approver if required
  
  // Evidence
  supportingDocs  String[]     // Document IDs
  reasoning       String?
  
  // Audit
  decisionDate    DateTime
  effectiveDate   DateTime?
  
  createdAt       DateTime     @default(now())
  
  @@map("decision_logs")
}

// ============================================
// USER PROFILE (Connected to Clerk)
// ============================================

model UserProfile {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  role      UserRole @default(STAFF)
  phone     String?
  
  // Preferences
  notificationPrefs Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  auditLogs       AuditLog[]
  memberships     OrganizationMember[]
  actionApprovals ActionApproval[]
  rateProposals   RateProposal[]
  
  @@map("user_profiles")
}

// ============================================
// INTEGRATIONS (NEW)
// ============================================

model IntegrationConnection {
  id              String             @id @default(cuid())
  organizationId  String
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  provider        IntegrationProvider
  name            String             // Friendly name "Main Xero Account"
  
  // Connection details (encrypted in production)
  credentials     Json?              // API keys, tokens, etc.
  
  // Sync settings
  syncFrequency   SyncFrequency      @default(DAILY)
  lastSyncAt      DateTime?
  lastSyncStatus  IntegrationStatus  @default(PENDING_AUTH)
  lastSyncError   String?
  
  // Scope
  propertyIds     String[]           // Which properties this integration covers
  
  isActive        Boolean            @default(true)
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Relations
  syncLogs        IntegrationSyncLog[]
  
  @@unique([organizationId, provider, name])
  @@map("integration_connections")
}

model IntegrationSyncLog {
  id              String              @id @default(cuid())
  connectionId    String
  connection      IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  startedAt       DateTime
  completedAt     DateTime?
  
  recordsProcessed Int               @default(0)
  recordsCreated   Int               @default(0)
  recordsUpdated   Int               @default(0)
  recordsFailed    Int               @default(0)
  
  status          IntegrationStatus
  errorMessage    String?
  errorDetails    Json?
  
  @@map("integration_sync_logs")
}

// ============================================
// ACCOUNTING PERIODS (NEW)
// ============================================

model AccountingPeriod {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name            String       // "January 2026", "Q1 2026"
  startDate       DateTime
  endDate         DateTime
  
  status          PeriodStatus @default(OPEN)
  
  // Close info
  closedBy        String?
  closedAt        DateTime?
  closedNotes     String?
  
  // Board pack generation
  boardPackUrl    String?
  boardPackGeneratedAt DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@unique([organizationId, startDate])
  @@map("accounting_periods")
}

// ============================================
// CORE ENTITIES (UPDATED with data provenance)
// ============================================

model Property {
  id              String         @id @default(cuid())
  organizationId  String?
  organization    Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  name            String
  type            PropertyType
  address         String
  city            String
  postcode        String
  description     String?
  imageUrl        String?
  
  // Financial
  purchasePrice   Float?
  currentValue    Float?
  mortgageBalance Float?
  interestRate    Float?
  
  // Mortgage & Strategy (Empire Brain)
  mortgageRate          Float?          // Current mortgage rate
  mortgageTermEndDate   DateTime?       // When current term ends
  penaltyFreeDate       DateTime?       // When early repayment penalty expires
  mortgageLender        String?         // Current lender name
  mortgageType          String?         // FIXED, VARIABLE, TRACKER
  lastValuationDate     DateTime?       // Date of last property valuation
  rentalYield           Float?          // Calculated annual rental yield %
  
  // Data provenance
  dataSource      DataSource     @default(MANUAL)
  lastUpdatedAt   DateTime       @default(now())
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  units            Unit[]
  dailyLogs        DailyLog[]
  expenses         Expense[]
  debts            Debt[]
  alerts           Alert[]
  hotelMetrics     HotelMetric[]
  cafeSales        CafeSales[]
  cafeTransactions CafeTransaction[]
  documents        Document[]
  transactions     FinancialTransaction[]
  pricingRules     PricingRule[]
  rateProposals    RateProposal[]
  
  @@map("properties")
}

model Unit {
  id           String     @id @default(cuid())
  propertyId   String
  property     Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  unitNumber   String
  floor        Int?
  type         String?
  status       UnitStatus @default(VACANT)
  currentRate  Float
  
  squareMeters Float?
  bedrooms     Int?
  bathrooms    Int?
  features     String[]
  
  // Data provenance
  dataSource      DataSource  @default(MANUAL)
  lastUpdatedAt   DateTime    @default(now())
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Relations
  bookings     Booking[]
  leases       Lease[]
  rentRolls    RentRoll[]
  
  @@unique([propertyId, unitNumber])
  @@map("units")
}

// ============================================
// THE "TRUTH" LAYER - Data Ingestion Models
// (UPDATED with full data provenance & reconciliation)
// ============================================

model FinancialTransaction {
  id            String              @id @default(cuid())
  propertyId    String?
  property      Property?           @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  date          DateTime            @db.Date
  amount        Float
  category      TransactionCategory
  description   String
  
  bankAccountId   String?
  bankAccountName String?
  reference       String?
  
  externalId    String?             @unique
  
  // ===== RECONCILIATION (NEW) =====
  reconciliationStatus ReconciliationStatus @default(PENDING)
  matchedToType        String?              // "HotelMetric", "CafeSales", "LeasePayment"
  matchedToId          String?
  matchedAmount        Float?
  matchVariance        Float?               // Difference if not exact match
  reconciledAt         DateTime?
  reconciledBy         String?
  
  // ===== DATA PROVENANCE (NEW) =====
  dataSource         DataSource      @default(MANUAL)
  confidence         DataConfidence  @default(MEDIUM)
  lastUpdatedAt      DateTime        @default(now())
  integrationId      String?         // Which integration imported this
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  @@index([date])
  @@index([category])
  @@index([reconciliationStatus])
  @@map("financial_transactions")
}

model HotelMetric {
  id           String   @id @default(cuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  date         DateTime @db.Date
  
  roomsAvailable  Int
  roomsOccupied   Int
  occupancy       Float
  
  adr             Float
  revpar          Float
  totalRevenue    Float
  roomRevenue     Float
  otherRevenue    Float    @default(0)
  
  arrivals        Int      @default(0)
  departures      Int      @default(0)
  stayovers       Int      @default(0)
  
  // ===== DATA PROVENANCE (NEW) =====
  dataSource         DataSource      @default(MANUAL)
  confidence         DataConfidence  @default(MEDIUM)
  lastUpdatedAt      DateTime        @default(now())
  integrationId      String?
  
  // ===== RECONCILIATION (NEW) =====
  reconciliationStatus ReconciliationStatus @default(PENDING)
  bankTxMatchedAmount  Float?
  bankTxVariance       Float?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([propertyId, date])
  @@index([date])
  @@index([reconciliationStatus])
  @@map("hotel_metrics")
}

model CafeSales {
  id           String   @id @default(cuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  date         DateTime @db.Date
  
  grossSales   Float
  netSales     Float?
  vat          Float?
  
  covers       Int
  avgSpend     Float?
  
  labourCost   Float    @default(0)
  foodCost     Float    @default(0)
  wastage      Float    @default(0)
  
  grossMargin  Float?
  labourPercentage Float?
  
  // ===== DATA PROVENANCE (NEW) =====
  dataSource         DataSource      @default(MANUAL)
  confidence         DataConfidence  @default(MEDIUM)
  lastUpdatedAt      DateTime        @default(now())
  integrationId      String?
  
  // ===== RECONCILIATION (NEW) =====
  reconciliationStatus ReconciliationStatus @default(PENDING)
  bankTxMatchedAmount  Float?
  bankTxVariance       Float?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([propertyId, date])
  @@index([date])
  @@index([reconciliationStatus])
  @@map("cafe_sales")
}

model RentRoll {
  id              String        @id @default(cuid())
  unitId          String
  unit            Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  tenantName      String
  tenantEmail     String?
  tenantPhone     String?
  
  leaseStart      DateTime
  leaseEnd        DateTime
  monthlyRent     Float
  
  paymentStatus   PaymentStatus @default(PENDING)
  arrearsAmount   Float         @default(0)
  arrearsDays     Int           @default(0)
  lastPaymentDate DateTime?
  nextDueDate     DateTime
  
  depositHeld     Float         @default(0)
  depositScheme   String?
  
  isActive        Boolean       @default(true)
  
  // ===== DATA PROVENANCE (NEW) =====
  dataSource         DataSource      @default(MANUAL)
  confidence         DataConfidence  @default(MEDIUM)
  lastUpdatedAt      DateTime        @default(now())
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([paymentStatus])
  @@index([arrearsDays])
  @@map("rent_rolls")
}

// ============================================
// RECONCILIATION ENGINE (NEW)
// ============================================

model ReconciliationRun {
  id              String   @id @default(cuid())
  
  runDate         DateTime @default(now())
  periodStart     DateTime
  periodEnd       DateTime
  
  // Scope
  propertyId      String?
  
  // Results
  totalBankTx     Int      @default(0)
  totalPmsTx      Int      @default(0)
  totalPosTx      Int      @default(0)
  
  matchedCount    Int      @default(0)
  unmatchedCount  Int      @default(0)
  flaggedCount    Int      @default(0)
  
  totalVariance   Float    @default(0)
  
  // Audit
  runBy           String?
  completedAt     DateTime?
  notes           String?
  
  // Relations
  items           ReconciliationItem[]
  
  @@map("reconciliation_runs")
}

model ReconciliationItem {
  id              String              @id @default(cuid())
  runId           String
  run             ReconciliationRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  
  // Source A (Bank)
  bankTxId        String?
  bankTxAmount    Float?
  bankTxDate      DateTime?
  
  // Source B (PMS/POS/Rent)
  sourceType      String              // "HotelMetric", "CafeSales", "LeasePayment"
  sourceId        String?
  sourceAmount    Float?
  sourceDate      DateTime?
  
  status          ReconciliationStatus
  variance        Float               @default(0)
  
  // Resolution
  resolvedBy      String?
  resolvedAt      DateTime?
  resolutionNote  String?
  
  @@map("reconciliation_items")
}

// ============================================
// THE "BRAIN" LAYER - Operations
// ============================================

model AuditLog {
  id          String      @id @default(cuid())
  userId      String
  user        UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String
  entityType  String
  entityId    String
  
  oldValue    Json?
  newValue    Json?
  
  ipAddress   String?
  userAgent   String?
  
  timestamp   DateTime    @default(now())
  
  @@index([entityType, entityId])
  @@index([userId])
  @@map("audit_logs")
}

model Document {
  id           String       @id @default(cuid())
  propertyId   String?
  property     Property?    @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  type         DocumentType
  name         String
  url          String
  
  expiryDate   DateTime?
  
  alertBefore  Int          @default(30)
  
  uploadedBy   String?
  notes        String?
  
  // ===== LEGAL BRAIN FIELDS (NEW) =====
  summary      String?                 // AI-generated summary
  isIndexed    Boolean      @default(false)  // Has been processed for RAG
  indexedAt    DateTime?
  pageCount    Int?
  fileSize     Int?                    // In bytes
  mimeType     String?
  
  // Data provenance
  dataSource      DataSource  @default(MANUAL)
  lastUpdatedAt   DateTime    @default(now())
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  // Relations
  chunks       DocumentChunk[]
  
  @@index([expiryDate])
  @@index([type])
  @@index([isIndexed])
  @@map("documents")
}

// ============================================
// LEGAL BRAIN - VECTOR STORE (NEW)
// ============================================

model DocumentChunk {
  id           String    @id @default(cuid())
  documentId   String
  document     Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Content
  content      String    // The actual text content of this chunk
  
  // Metadata
  pageNumber   Int?
  chunkIndex   Int       // Order within document
  charStart    Int?      // Starting character position in original doc
  charEnd      Int?      // Ending character position
  
  // Tokens (for context window management)
  tokenCount   Int?
  
  // The embedding vector is stored in a separate table via raw SQL
  // We'll use Supabase's pgvector extension
  hasEmbedding Boolean   @default(false)
  
  createdAt    DateTime  @default(now())
  
  @@index([documentId])
  @@index([hasEmbedding])
  @@map("document_chunks")
}

// ============================================
// ACTION ITEMS - FULL WORKFLOW (UPDATED)
// ============================================

model ActionItem {
  id                String               @id @default(cuid())
  
  title             String
  description       String?
  
  priority          Priority             @default(MEDIUM)
  
  // ===== WORKFLOW STATUS (UPDATED) =====
  workflowStatus    ActionWorkflowStatus @default(DRAFT)
  actionType        ActionType?
  
  // Impact & Urgency
  estimatedImpactGbp Float?
  urgencyScore       Int?
  
  // Assignment
  assignedTo        String?
  
  // Dates
  dueDate           DateTime?
  scheduledFor      DateTime?
  executedAt        DateTime?
  verifiedAt        DateTime?
  
  // Categorization
  category          String?
  relatedPropertyId String?
  
  // Auto-generation source (for AI evidence)
  source            String?
  sourceEntityType  String?
  sourceEntityId    String?
  
  // ===== AI EVIDENCE (NEW) =====
  aiReasoningJson   Json?                // Full reasoning chain
  aiConfidence      Float?               // 0-1 confidence score
  aiSourceRecords   String[]             // IDs of records used
  
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  
  // Relations
  approvals         ActionApproval[]
  executions        ActionExecution[]
  
  @@index([priority, workflowStatus])
  @@index([dueDate])
  @@map("action_items")
}

model ActionApproval {
  id           String      @id @default(cuid())
  actionId     String
  action       ActionItem  @relation(fields: [actionId], references: [id], onDelete: Cascade)
  
  approverId   String
  approver     UserProfile @relation(fields: [approverId], references: [id])
  
  approved     Boolean
  comments     String?
  
  createdAt    DateTime    @default(now())
  
  @@map("action_approvals")
}

model ActionExecution {
  id           String     @id @default(cuid())
  actionId     String
  action       ActionItem @relation(fields: [actionId], references: [id], onDelete: Cascade)
  
  stepNumber   Int
  stepName     String     // "GENERATE_EMAIL", "SEND_EMAIL", "LOG_RESPONSE"
  
  status       String     // "PENDING", "SUCCESS", "FAILED"
  
  inputData    Json?
  outputData   Json?
  errorMessage String?
  
  executedAt   DateTime?
  
  createdAt    DateTime   @default(now())
  
  @@map("action_executions")
}

// ============================================
// PRICING ENGINE (NEW)
// ============================================

model PricingRule {
  id           String    @id @default(cuid())
  propertyId   String
  property     Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  name         String
  
  // Rate bounds
  minRate      Float
  maxRate      Float
  baseRate     Float
  
  // Seasonal multipliers
  seasonType   SeasonType?
  seasonMultiplier Float   @default(1.0)
  
  // Day of week factors (JSON: {"monday": 0.9, "friday": 1.2, ...})
  dayOfWeekFactors Json?
  
  // Lead time adjustments
  leadTimeDays     Int?       // If booking is X days out
  leadTimeMultiplier Float?
  
  // Occupancy-based adjustments
  occupancyThresholdLow  Float?  // Below this, discount
  occupancyThresholdHigh Float?  // Above this, surge
  lowOccupancyMultiplier Float?
  highOccupancyMultiplier Float?
  
  isActive     Boolean   @default(true)
  
  validFrom    DateTime?
  validTo      DateTime?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  @@map("pricing_rules")
}

model RateProposal {
  id           String            @id @default(cuid())
  propertyId   String
  property     Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Proposal details
  currentRate  Float
  proposedRate Float
  changePercent Float
  
  effectiveFrom DateTime
  effectiveTo   DateTime?
  
  // Reasoning (AI or manual)
  reasoning    String
  aiGenerated  Boolean           @default(false)
  aiSourceRecords String[]
  
  status       RateProposalStatus @default(DRAFT)
  
  // Approval
  createdBy    String
  creator      UserProfile       @relation(fields: [createdBy], references: [id])
  approvedBy   String?
  approvedAt   DateTime?
  rejectedReason String?
  
  // Application
  appliedAt    DateTime?
  
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  @@map("rate_proposals")
}

// ============================================
// DEBT & COVENANT ENGINE (NEW)
// ============================================

model Debt {
  id            String    @id @default(cuid())
  propertyId    String?
  property      Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  lender        String
  loanType      String
  
  principal     Float
  currentBalance Float
  interestRate  Float
  
  monthlyPayment Float
  
  startDate     DateTime
  maturityDate  DateTime
  
  isFixed       Boolean   @default(true)
  fixedUntil    DateTime?
  
  notes         String?
  
  // Data provenance
  dataSource      DataSource  @default(MANUAL)
  lastUpdatedAt   DateTime    @default(now())
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  covenants     LoanCovenant[]
  stressTests   DebtStressTest[]
  
  @@map("debts")
}

model LoanCovenant {
  id           String   @id @default(cuid())
  debtId       String
  debt         Debt     @relation(fields: [debtId], references: [id], onDelete: Cascade)
  
  metric       String   // "DSCR", "LTV", "ICR" (Interest Coverage Ratio)
  threshold    Float    // e.g., 1.25 for DSCR
  operator     String   // ">=", "<=", ">"
  
  currentValue Float?
  lastCheckedAt DateTime?
  
  isBreached   Boolean  @default(false)
  breachDate   DateTime?
  breachNotes  String?
  
  // Next test date
  nextTestDate DateTime?
  testFrequency String?  // "MONTHLY", "QUARTERLY", "ANNUAL"
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("loan_covenants")
}

model DebtStressTest {
  id           String   @id @default(cuid())
  debtId       String
  debt         Debt     @relation(fields: [debtId], references: [id], onDelete: Cascade)
  
  scenario     String   // "Base", "+1% Rate", "+2% Rate", "10% Revenue Drop"
  
  // Input assumptions
  rateChange   Float?   // +1.0 = 1% increase
  revenueChange Float?  // -0.1 = 10% decrease
  
  // Results
  newMonthlyPayment Float?
  newDscr           Float?
  newLtv            Float?
  
  canServiceDebt    Boolean?
  breaksCovenants   Boolean?
  
  runAt        DateTime @default(now())
  runBy        String?
  
  @@map("debt_stress_tests")
}

// ============================================
// BUSINESS MODULES
// ============================================

model Booking {
  id           String        @id @default(cuid())
  unitId       String
  unit         Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  // External system IDs (for webhook sync)
  cloudbedsReservationId  String?   @unique
  cloudbedsPropertyId     String?
  
  guestName    String
  guestEmail   String?
  guestPhone   String?
  adults       Int           @default(1)
  children     Int           @default(0)
  
  checkIn      DateTime
  checkOut     DateTime
  nights       Int
  
  channel      BookingChannel
  status       BookingStatus @default(CONFIRMED)
  
  roomRate     Float
  totalPrice   Float
  deposit      Float         @default(0)
  balance      Float         @default(0)
  
  specialRequests String?
  internalNotes   String?
  
  // Data provenance
  dataSource      DataSource  @default(MANUAL)
  lastUpdatedAt   DateTime    @default(now())
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  @@index([cloudbedsReservationId])
  @@map("bookings")
}

model Lease {
  id              String        @id @default(cuid())
  unitId          String
  unit            Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  tenantName      String
  tenantEmail     String?
  tenantPhone     String?
  
  startDate       DateTime
  endDate         DateTime
  
  rentAmount      Float
  deposit         Float
  paymentStatus   PaymentStatus @default(PENDING)
  arrearsAmount   Float         @default(0)
  lastPaymentDate DateTime?
  
  rightToRentCheck Boolean      @default(false)
  gasCertExpiry    DateTime?
  epcRating        String?
  
  notes           String?
  
  // Data provenance
  dataSource      DataSource  @default(MANUAL)
  lastUpdatedAt   DateTime    @default(now())
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  payments        LeasePayment[]
  
  @@map("leases")
}

model LeasePayment {
  id          String   @id @default(cuid())
  leaseId     String
  lease       Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  
  amount      Float
  dueDate     DateTime
  paidDate    DateTime?
  status      PaymentStatus @default(PENDING)
  method      String?
  reference   String?
  
  // Reconciliation
  reconciliationStatus ReconciliationStatus @default(PENDING)
  bankTxId             String?
  
  // Data provenance
  dataSource      DataSource  @default(MANUAL)
  lastUpdatedAt   DateTime    @default(now())
  
  createdAt   DateTime @default(now())
  
  @@map("lease_payments")
}

model DailyLog {
  id           String   @id @default(cuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  date         DateTime @db.Date
  
  salesTotal   Float    @default(0)
  roomRevenue  Float    @default(0)
  fbRevenue    Float    @default(0)
  otherRevenue Float    @default(0)
  
  laborCost    Float    @default(0)
  foodCost     Float    @default(0)
  utilityCost  Float    @default(0)
  otherCost    Float    @default(0)
  
  covers       Int      @default(0)
  occupancy    Float?
  adr          Float?
  revpar       Float?
  
  notes        String?
  weatherNote  String?
  
  // Data provenance
  dataSource      DataSource  @default(MANUAL)
  lastUpdatedAt   DateTime    @default(now())
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([propertyId, date])
  @@map("daily_logs")
}

// ============================================
// FINANCE LAYER
// ============================================

model Expense {
  id           String         @id @default(cuid())
  propertyId   String?
  property     Property?      @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  amount       Float
  category     ExpenseCategory
  vendor       String
  description  String?
  invoiceRef   String?
  
  status       ExpenseStatus  @default(PENDING)
  
  dueDate      DateTime?
  paidDate     DateTime?
  
  isRecurring  Boolean        @default(false)
  recurringDay Int?
  
  // Approval workflow
  approvedBy   String?
  approvedAt   DateTime?
  
  // Data provenance
  dataSource      DataSource  @default(MANUAL)
  lastUpdatedAt   DateTime    @default(now())
  
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  @@map("expenses")
}

// ============================================
// ALERTS & NOTIFICATIONS
// ============================================

model Alert {
  id           String        @id @default(cuid())
  propertyId   String?
  property     Property?     @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  title        String
  message      String
  
  severity     AlertSeverity
  category     AlertCategory
  
  isRead       Boolean       @default(false)
  isDismissed  Boolean       @default(false)
  
  source       String?
  
  relatedType  String?
  relatedId    String?
  
  // AI evidence
  aiSourceRecords String[]
  
  createdAt    DateTime      @default(now())
  
  @@map("alerts")
}

// ============================================
// FORECASTING & ANALYTICS
// ============================================

model Forecast {
  id           String   @id @default(cuid())
  
  date         DateTime @db.Date
  propertyId   String?
  
  predictedRevenue   Float?
  predictedOccupancy Float?
  predictedCovers    Float?
  
  confidenceLevel    Float?
  
  modelVersion       String?
  
  // AI evidence
  aiSourceRecords    String[]
  
  createdAt    DateTime @default(now())
  
  @@unique([date, propertyId])
  @@map("forecasts")
}

// ============================================
// CASH POSITION
// ============================================

model CashPosition {
  id           String   @id @default(cuid())
  
  date         DateTime @db.Date @unique
  
  operatingBalance   Float @default(0)
  reserveBalance     Float @default(0)
  
  inflows      Float    @default(0)
  outflows     Float    @default(0)
  
  projected30Day     Float?
  projected90Day     Float?
  
  notes        String?
  
  // Data provenance
  dataSource      DataSource      @default(MANUAL)
  confidence      DataConfidence  @default(MEDIUM)
  lastUpdatedAt   DateTime        @default(now())
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("cash_positions")
}

// ============================================
// ENERGY & GRID MANAGEMENT (NEW)
// ============================================

enum SensorType {
  THERMOSTAT
  SMART_PLUG
  ENERGY_METER
  MOTION_SENSOR
  DOOR_SENSOR
  WATER_HEATER
  HVAC_CONTROLLER
}

enum SensorStatus {
  ONLINE
  OFFLINE
  ERROR
  MAINTENANCE
}

enum HVACMode {
  ECO          // 16°C - Vacant rooms
  COMFORT      // 21°C - Occupied rooms
  BOOST        // 24°C - Guest request
  OFF
  AUTO
}

enum EnergyActionType {
  HVAC_ECO_MODE
  HVAC_COMFORT_MODE
  HVAC_BOOST_MODE
  HVAC_OFF
  WATER_HEATER_ON
  WATER_HEATER_OFF
  SMART_PLUG_ON
  SMART_PLUG_OFF
  GRID_ARBITRAGE_START
  GRID_ARBITRAGE_END
}

model RoomSensor {
  id           String       @id @default(cuid())
  unitId       String
  
  // Sensor identification
  type         SensorType
  vendorId     String       // External device ID (e.g., Hive, Nest, Tado)
  vendorName   String?      // "Hive", "Nest", "Tado", "Shelly"
  name         String?      // Friendly name "Room 101 Thermostat"
  
  // Current state
  status       SensorStatus @default(ONLINE)
  lastSeen     DateTime     @default(now())
  
  // For thermostats
  currentTemp  Float?       // Current temperature reading
  targetTemp   Float?       // Target temperature
  hvacMode     HVACMode?    // Current mode
  humidity     Float?       // If sensor supports it
  
  // For smart plugs / energy meters
  currentPower Float?       // Current wattage
  todayKwh     Float?       // kWh used today
  isOn         Boolean?     // On/Off state
  
  // For motion/door sensors
  lastMotion   DateTime?
  doorOpen     Boolean?
  
  // Metadata
  batteryLevel Int?         // 0-100 for battery-powered sensors
  firmwareVersion String?
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  // Relations
  energyEvents EnergyEvent[]
  
  @@unique([unitId, type, vendorId])
  @@index([type])
  @@index([status])
  @@map("room_sensors")
}

model EnergyEvent {
  id           String          @id @default(cuid())
  sensorId     String?
  sensor       RoomSensor?     @relation(fields: [sensorId], references: [id], onDelete: SetNull)
  
  // Event details
  timestamp    DateTime        @default(now())
  actionType   EnergyActionType
  actionTaken  String          // Human-readable description
  
  // Trigger context
  triggerReason String?        // "Room vacant", "Guest arriving in 2h", "Grid price low"
  occupancyStatus String?      // "VACANT", "OCCUPIED", "ARRIVING_SOON"
  
  // Energy metrics
  previousTemp  Float?         // Temperature before action
  newTemp       Float?         // Temperature after action
  gridPriceGbp  Float?         // Grid price at time of action (£/kWh)
  
  // Savings estimates
  kwhSavedEst   Float?         // Estimated kWh saved
  costSavedEst  Float?         // Estimated cost saved (GBP)
  co2SavedEst   Float?         // Estimated CO2 saved (kg)
  
  // Audit
  initiatedBy   String?        // "EnergyAgent", "Manual", "Schedule"
  agentRunId    String?        // Reference to the agent run
  
  // Verification
  verified      Boolean        @default(false)
  verifiedKwh   Float?         // Actual kWh saved (if measured)
  
  createdAt     DateTime       @default(now())
  
  @@index([timestamp])
  @@index([actionType])
  @@index([sensorId])
  @@map("energy_events")
}

model GridPrice {
  id           String   @id @default(cuid())
  
  timestamp    DateTime @unique
  priceGbp     Float    // Price per kWh in GBP
  
  // Market data
  region       String   @default("UK")
  supplier     String?  // "Octopus Agile", "British Gas", etc.
  tariffType   String?  // "AGILE", "FIXED", "ECONOMY_7"
  
  // Predictions
  predictedHigh Boolean @default(false)  // Is this a peak period?
  predictedLow  Boolean @default(false)  // Is this an off-peak bargain?
  
  createdAt    DateTime @default(now())
  
  @@index([timestamp])
  @@map("grid_prices")
}

model EnergySummary {
  id           String   @id @default(cuid())
  
  date         DateTime @db.Date @unique
  
  // Daily totals
  totalKwhUsed    Float @default(0)
  totalKwhSaved   Float @default(0)
  totalCostGbp    Float @default(0)
  totalSavedGbp   Float @default(0)
  totalCo2Saved   Float @default(0)
  
  // Breakdown by action type
  hvacInterventions  Int   @default(0)
  gridArbitrageEvents Int  @default(0)
  
  // Occupancy-linked stats
  roomsSetToEco      Int   @default(0)
  roomsPreHeated     Int   @default(0)
  
  // Average metrics
  avgGridPrice       Float?
  avgTempDelta       Float?  // Average temperature reduction
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("energy_summaries")
}

// ============================================
// WEBHOOK INTEGRATION ENGINE
// Zero-Data-Entry Strategy
// ============================================

enum WebhookProvider {
  CLOUDBEDS
  SQUARE
  XERO
  STRIPE
  BANK
}

enum WebhookStatus {
  RECEIVED
  PROCESSED
  FAILED
  IGNORED
}

// Log every incoming webhook for debugging
model IntegrationLog {
  id           String         @id @default(cuid())
  
  provider     WebhookProvider
  eventType    String          // e.g., "reservation_created", "payment.updated"
  
  // Raw data
  payload      Json            // The full JSON payload
  headers      Json?           // Request headers for debugging
  signature    String?         // The signature header for verification
  
  // Processing result
  status       WebhookStatus   @default(RECEIVED)
  errorMessage String?
  processedAt  DateTime?
  
  // Linked records (optional, for tracing)
  linkedRecordType String?     // "Booking", "CafeTransaction", etc.
  linkedRecordId   String?
  
  // Request metadata
  ipAddress    String?
  userAgent    String?
  
  createdAt    DateTime @default(now())
  
  @@index([provider, eventType])
  @@index([status])
  @@index([createdAt])
  @@map("integration_logs")
}

// Individual cafe transactions from Square POS
model CafeTransaction {
  id           String   @id @default(cuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Square identifiers
  squareOrderId     String   @unique
  squarePaymentId   String?
  squareLocationId  String?
  
  // Transaction details
  timestamp         DateTime
  
  // Money breakdown (in pence/cents)
  grossAmount       Int      // Total before discounts
  discountAmount    Int      @default(0)
  tipAmount         Int      @default(0)
  taxAmount         Int      @default(0)
  netAmount         Int      // Final amount after discounts, before tips
  
  // Order details
  itemCount         Int      @default(0)
  orderItems        Json?    // Array of line items
  
  // Payment details
  paymentMethod     String?  // "CARD", "CASH", "GIFT_CARD"
  cardBrand         String?  // "VISA", "MASTERCARD", etc.
  
  // Staff
  employeeId        String?
  employeeName      String?
  
  // Status
  isRefunded        Boolean  @default(false)
  refundAmount      Int      @default(0)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([timestamp])
  @@index([propertyId, timestamp])
  @@map("cafe_transactions")
}
